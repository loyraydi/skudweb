{% extends 'myapp/base.html' %}

{% block content %}

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-lg border-0 rounded-4">
        <div class="card-header bg-primary text-white text-center py-3">
          <h2 class="mb-0">{% if device %}Редактировать устройство{% else %}Добавить устройство{% endif %}</h2>
        </div>
        <div class="card-body p-4">
          <form method="POST">
            {% csrf_token %}

            <!-- Имя устройства -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Название устройства:</label>
              <input type="text" name="name" class="form-control" value="{{ device.name|default_if_none:'' }}" required>
            </div>

            <!-- MAC-адрес -->
            <div class="mb-3">
              <label class="form-label fw-semibold">MAC-адрес:</label>
              <input type="text" name="mac" class="form-control" value="{{ device.mac|default_if_none:'' }}" required>
            </div>

            <!-- Токен -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Токен устройства:</label>
              <div class="input-group">
                <input type="text" id="token" name="token" class="form-control" value="{{ device.token|default_if_none:generated_token }}" readonly>
                <button type="button" class="btn btn-outline-secondary" onclick="generateToken()">Сгенерировать</button>
              </div>
            </div>

            <!-- Активность устройства -->
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="device_activated" name="device_activated" {% if device.device_activated %}checked{% endif %}>
              <label class="form-check-label" for="device_activated">Активно</label>
            </div>

            <!-- API команды -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Настройки API (JSON):</label>
              <textarea name="device_api" class="form-control" rows="4">{{ device.device_api|default_if_none:'' }}</textarea>
            </div>

            <!-- Календарь работы -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Рабочие дни:</label>
              <input type="text" name="open_day" class="form-control" value="{{ device.calendar_regular.open_day|join:', '|default_if_none:'' }}">
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Время открытия:</label>
              <input type="time" name="open_time" class="form-control" value="{{ device.calendar_regular.open_time|default_if_none:'' }}">
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Дни закрытия:</label>
              <input type="text" name="close_day" class="form-control" value="{{ device.calendar_regular.close_day|join:', '|default_if_none:'' }}">
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Время закрытия:</label>
              <input type="time" name="close_time" class="form-control" value="{{ device.calendar_regular.close_time|default_if_none:'' }}">
            </div>

            <!-- Исключения -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Исключения (дни открытия):</label>
              <input type="text" name="exception_open_day" class="form-control" value="{{ device.calendar_exception.open_day|join:', '|default_if_none:'' }}">
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Исключения (дни закрытия):</label>
              <input type="text" name="exception_close_day" class="form-control" value="{{ device.calendar_exception.close_day|join:', '|default_if_none:'' }}">
            </div>

            <!-- Максимальное количество попыток -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Максимальные попытки изменения состояния:</label>
              <select name="trying_max" class="form-select">
                <option value="1" {% if device.trying_max == 1 %}selected{% endif %}>1</option>
                <option value="2" {% if device.trying_max == 2 %}selected{% endif %}>2</option>
                <option value="3" {% if device.trying_max == 3 %}selected{% endif %}>3</option>
                <option value="4" {% if device.trying_max == 4 or device.trying_max is None %}selected{% endif %}>4</option>
              </select>
            </div>

            <!-- Кнопки -->
            <div class="d-flex justify-content-between mt-4">
              <button type="submit" class="btn btn-primary w-100 me-2">Сохранить</button>
              <a class="btn btn-secondary w-100" href="{% url 'device_list' %}">Отмена</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function generateToken() {
    const token = [...Array(64)].map(() => Math.random().toString(36)[2]).join('');
    document.getElementById('token').value

{% endblock %}