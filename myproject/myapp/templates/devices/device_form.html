{% extends 'myapp/base.html' %}

{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-4">
  <h2>{{ device.name|default:"Новое устройство" }}</h2>
  <form method="post">
    {% csrf_token %}

    <div class="mb-3">
      <label for="id_name" class="form-label">Имя устройства</label>
      {{ form.name|add_class:"form-control" }}
    </div>

    <div class="mb-3">
      <label for="id_mac" class="form-label">MAC-адрес</label>
      {{ form.mac|add_class:"form-control" }}
    </div>

    <div class="form-check mb-3">
      {{ form.device_activated|add_class:"form-check-input" }}
      <label class="form-check-label" for="id_device_activated">
        Устройство активно
      </label>
    </div>

    <!-- Toggle calendar -->
    <div class="form-check mb-3">
      <input type="checkbox" name="calendar_toggle" id="calendarToggle" class="form-check-input">
      <label class="form-check-label" for="calendarToggle">
        Включить календарь
      </label>
    </div>

    <!-- Calendar fields -->
    <div id="calendarFields" style="display: none;">
      <div class="mb-3">
        <label for="id_open_day" class="form-label">Дни открытия (через запятую)</label>
        <input type="text" name="open_day" id="id_open_day" class="form-control" value="{{ device.open_day|default:'' }}">
      </div>

      <div class="mb-3">
        <label for="id_open_time" class="form-label">Время открытия</label>
        <input type="text" name="open_time" id="id_open_time" class="form-control" value="{{ device.open_time|default:'' }}">
      </div>

      <div class="mb-3">
        <label for="id_close_day" class="form-label">Дни закрытия (через запятую)</label>
        <input type="text" name="close_day" id="id_close_day" class="form-control" value="{{ device.close_day|default:'' }}">
      </div>

      <div class="mb-3">
        <label for="id_close_time" class="form-label">Время закрытия</label>
        <input type="text" name="close_time" id="id_close_time" class="form-control" value="{{ device.close_time|default:'' }}">
      </div>

      <h5 class="mt-4">Исключения</h5>

      <div class="mb-3">
        <label for="id_exception_open_day" class="form-label">Дни исключений открытия (через запятую)</label>
        <input type="text" name="exception_open_day" id="id_exception_open_day" class="form-control" value="{{ device.exception_open_day|default:'' }}">
      </div>

      <div class="mb-3">
        <label for="id_exception_close_day" class="form-label">Дни исключений закрытия (через запятую)</label>
        <input type="text" name="exception_close_day" id="id_exception_close_day" class="form-control" value="{{ device.exception_close_day|default:'' }}">
      </div>

      <!-- Скрытые поля для JSON -->
      {{ form.calendar_regular|add_class:"d-none" }}
      {{ form.calendar_exception|add_class:"d-none" }}
    </div>

    <!-- Device API with CodeMirror -->
    <div class="mb-3">
      <label for="id_device_api" class="form-label">Device API (JSON)</label>
      {{ form.device_api|add_class:"form-control"|attr:"id:id_device_api" }}
    </div>

    <div class="mb-3">
      <label for="id_trying_max" class="form-label">Попыток авторизации</label>
      {{ form.trying_max|add_class:"form-control" }}
    </div>

    <button type="submit" class="btn btn-success">Сохранить</button>
    <a href="{% url 'device_list' %}" class="btn btn-secondary">Назад</a>
  </form>
</div>

<!-- CodeMirror + Toggle script -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/brace-fold.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.min.css">

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.getElementById("calendarToggle");
    const calendarFields = document.getElementById("calendarFields");

    function updateVisibility() {
      calendarFields.style.display = toggle.checked ? "block" : "none";
    }

    toggle.addEventListener("change", updateVisibility);

    // При редактировании: показать календарь если есть данные
    const openDayValue = document.getElementById("id_open_day")?.value || '';
    const closeDayValue = document.getElementById("id_close_day")?.value || '';
    const exceptionOpenDayValue = document.getElementById("id_exception_open_day")?.value || '';
    const exceptionCloseDayValue = document.getElementById("id_exception_close_day")?.value || '';

    if (openDayValue.trim() !== "" || closeDayValue.trim() !== "" ||
            exceptionOpenDayValue.trim() !== "" || exceptionCloseDayValue.trim() !== "") {
      toggle.checked = true;
    }

    updateVisibility();

    // Улучшенный CodeMirror
    const deviceApiTextarea = document.getElementById("id_device_api");
    if (deviceApiTextarea) {
      // Сначала попробуем распарсить и отформатировать JSON
      try {
        let jsonValue = deviceApiTextarea.value;
        // Удаляем экранированные символы, если они есть
        if (jsonValue.includes('\\n') || jsonValue.includes('\\"')) {
          jsonValue = JSON.parse('"' + jsonValue.replace(/"/g, '\\"') + '"');
        }
        // Форматируем JSON
        const parsedJson = JSON.parse(jsonValue);
        deviceApiTextarea.value = JSON.stringify(parsedJson, null, 2);
      } catch (e) {
        console.error("Ошибка форматирования JSON:", e);
      }

      // Инициализируем CodeMirror
      const editor = CodeMirror.fromTextArea(deviceApiTextarea, {
        mode: { name: "javascript", json: true },
        theme: "dracula",
        lineNumbers: true,
        lineWrapping: false,
        autoCloseBrackets: true,
        matchBrackets: true,
        indentUnit: 2,
        tabSize: 2,
        height: "auto",
        viewportMargin: Infinity
      });

      // Добавляем кнопку форматирования
      const formatButton = document.createElement("button");
      formatButton.textContent = "Форматировать JSON";
      formatButton.className = "btn btn-sm btn-secondary mt-2";
      formatButton.onclick = function(e) {
        e.preventDefault();
        try {
          const value = editor.getValue();
          const parsedJson = JSON.parse(value);
          const formattedJson = JSON.stringify(parsedJson, null, 2);
          editor.setValue(formattedJson);
        } catch (e) {
          alert("Невалидный JSON: " + e.message);
        }
      };

      // Добавляем кнопку после редактора
      editor.getWrapperElement().parentNode.insertBefore(
              formatButton,
              editor.getWrapperElement().nextSibling
      );
    }
  });
</script>
{% endblock %}