{% extends "myapp/base.html" %}

{% block content %}

<style>
    .grid-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 3 колонки */
        grid-gap: 10px;
        min-height: 60vh;
        padding: 20px;
    }

    .grid-item {
        color: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgb(33, 37, 41);
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .placeholder {
        visibility: hidden; /* По умолчанию скрываем */
        border: 2px dashed gray;
        background: rgba(255, 255, 255, 0.1);
        min-height: 100px;
    }
    .edit-mode .placeholder {
        visibility: visible; /* Показываем в режиме редактирования */
    }
    .page-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .button-group {
        display: flex;
        gap: 10px; /* Расстояние между кнопками */
    }
    .edit-button, .icon-button {
        font-size: 20px;
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
    }
    .icon-button:hover {
        color: #0d6dfb; /* Изменение цвета при наведении */
    }
    .icon-button:focus {
        outline: none;
    }
    .edit-button i {
        color: #ffffff; /* Полупрозрачный белый */
    }

    .edit-button:hover i {
        color: #0d6dfb; /* Чистый белый при наведении */
    }
    #dashboard {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
    }

    .dashboard-container {
        background-color: #212529;
        color: white;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        width: auto;
        max-width: 350px;
        transform: translateX(100%);
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
        opacity 0.4s ease;
        border-left: 4px solid #4a6cf7;
        overflow: hidden;
    }

    .dashboard.show {
        transform: translateX(0);
        opacity: 1;
    }

    .dashboard.hide {
        transform: translateX(100%);
        opacity: 0;
    }

    .dashboard-icon {
        margin-right: 15px;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .dashboard-content {
        flex-grow: 1;
    }

    .dashboard-title {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 16px;
    }

    .dashboard-message {
        font-size: 14px;
        opacity: 0.9;
    }

    .dashboard-close {
        cursor: pointer;
        font-size: 18px;
        margin-left: 10px;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .dashboard-close:hover {
        opacity: 1;
    }

    .dashboard-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background-color: rgba(255, 255, 255, 0.5);
        width: 100%;
        transform-origin: left;
    }

    /* Типы уведомлений */
    .dashboard-success {
        border-left-color: #4a6cf7;
    }

    .dashboard-error {
        border-left-color: #dc3545;
    }

    .dashboard-warning {
        border-left-color: #ffc107;
    }

    .dashboard-info {
        border-left-color: #4a6cf7;
    }
</style>

<div class="container">



    <h1 class="page-title">
        Главная
        <div class="button-group">
            <button id="editModeToggle" class="edit-button">
                <i class='bx bxs-edit-alt'></i>
            </button>
            <button id="saveLayout" class="icon-button" style="visibility: hidden;">
                <i class="bx bx-save"></i>
            </button>
        </div>
    </h1>

    <div id="dashboard"></div>

    <div class="grid-container" id="grid">
        <div class="grid-item" id="lastUserCard">
            <div class="card">
                <div class="card-header bg-success text-white">
                    Последний зарегистрированный пользователь
                </div>
                <div class="card-body">
                    <p><strong>Имя пользователя:</strong> <span id="last_user_name">Загрузка...</span></p>
                    <p><strong>Должность:</strong> <span id="last_user_occupations">Загрузка...</span></p>
                </div>
            </div>
        </div>

        <div class="grid-item" id="deviceCard">
            <div class="card">
                <div class="card-header bg-success text-white">
                    Последнее зарегистрированное устройство
                </div>
                <div class="card-body">
                    <p><strong>Название устройства:</strong> <span id="last_device_name">Загрузка...</span></p>
                    <p><strong>Активировано:</strong> <span id="last_device_activated">Загрузка...</span></p>
                </div>
            </div>
        </div>


        <div class="grid-item" id="logsCard">
            <div class="card">
                <div class="card-header bg-info text-white">
                    Последние логи
                </div>
                <div class="card-body">
                    <ul id="logs-list" class="list-group">
                        <li class="list-group-item">Загрузка логов...</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Пустые места для вставки блоков -->
        <div class="grid-item placeholder"></div>
        <div class="grid-item placeholder"></div>
        <div class="grid-item placeholder"></div>
    </div>
</div>

<script>
    let lastUserId = null;  // Переменная для хранения ID последнего пользователя
    let lastDeviceId = null;

    function fetchDashboardData() {
        fetch("{% url 'get_dashboard_data' %}")
            .then(response => response.json())
            .then(data => {
                // Проверяем, изменился ли последний пользователь
                if (data.last_user.id_user !== lastUserId) {
                    lastUserId = data.last_user.id_user;
                    document.getElementById("last_user_name").textContent = data.last_user.user_name;
                    document.getElementById("last_user_occupations").textContent = data.last_user.occupations;
                }
                // Обновляем логи
                let logsList = document.getElementById("logs-list");
                logsList.innerHTML = "";

                data.logs.forEach(log => {
                    let listItem = document.createElement("li");
                    listItem.className = "list-group-item";
                    listItem.innerHTML = `<strong>[${log.datetime}]</strong> ${log.message} (${log.auditory_number})`;
                    logsList.appendChild(listItem);
                });
            })
            .catch(error => console.error("Ошибка загрузки данных:", error));

        fetch("{% url 'get_dashboard_data' %}")
            .then(response => response.json())
            .then(data => {

                if (data.last_device && data.last_device.id_device) {

                    let deviceCard = document.getElementById("deviceCard");
                    if (deviceCard) {
                        document.getElementById("last_device_name").textContent = data.last_device.device_name;
                        let activatedText = data.last_device.activated ?
                            '<span class="badge bg-success">Активно</span>' :
                            '<span class="badge bg-danger">Отключено</span>';

                        document.getElementById("last_device_activated").innerHTML = activatedText;
                    } else {
                        console.warn("Элемент #deviceCard не найден в DOM");
                    }
                }
            })
            .catch(error => console.error("Ошибка загрузки данных:", error));
    }

    // Запрашиваем данные каждые 5 секунд
    setInterval(fetchDashboardData, 5000);
    fetchDashboardData();

    let editMode = false;

    function loadLayout() {
        let savedLayout = localStorage.getItem("gridLayout");
        if (savedLayout) {
            document.getElementById("grid").innerHTML = savedLayout;

            // Проверяем, есть ли все ключевые контейнеры
            let requiredElements = ["lastUserCard", "deviceCard", "logsCard"];
            let missingElements = requiredElements.filter(id => !document.getElementById(id));

            if (missingElements.length > 0) {
                console.warn("Некоторые контейнеры отсутствуют, сбрасываем макет:", missingElements);
                localStorage.removeItem("gridLayout"); // Удаляем сохраненный макет
                location.reload(); // Перезагружаем страницу, чтобы вернуть стандартное расположение
            }
        }
    }

    function saveLayout() {
        localStorage.setItem("gridLayout", document.getElementById("grid").innerHTML);
    }

    function enableEditing() {
        editMode = true;
        new Sortable(document.getElementById("grid"), {
            animation: 150,
            ghostClass: "sortable-ghost",
            filter: ".placeholder",
            preventOnFilter: false
        });
        document.getElementById("saveLayout").style.visibility = "visible";
    }

    function disableEditing() {
        editMode = false;
        document.getElementById("saveLayout").style.visibility = "hidden";
    }

    document.getElementById("editModeToggle").addEventListener("click", function () {
        if (!editMode) {
            enableEditing();
            this.innerHTML = "<i class='bx bx-check'></i>";  // Изменяем иконку на галочку
            this.classList.add("btn-danger");
        } else {
            disableEditing();
            this.innerHTML = "<i class='bx bxs-edit-alt'></i>";  // Возвращаем иконку редактирования
            this.classList.remove("btn-danger");
        }
    });

    document.getElementById("saveLayout").addEventListener("click", function () {
        saveLayout();
        showDashboardNotification("Расположение блоков сохранено!", "success", "Успешно");
    });

    // Загружаем сохраненное расположение
    loadLayout();
    document.getElementById("editModeToggle").addEventListener("click", function () {
        document.body.classList.toggle("edit-mode");
    });
    // Функция для создания и показа уведомления
    function showDashboardNotification(message, type = 'success', title = '', duration = 3000) {
        // Создаем уникальный контейнер для уведомлений дашборда, если он не существует
        let container = document.getElementById('dashboard-notifications');

        if (!container) {
            container = document.createElement('div');
            container.id = 'dashboard-notifications';
            container.style.position = 'fixed';
            container.style.bottom = '20px';
            container.style.right = '20px';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }

        // Создаем уведомление
        const notification = document.createElement('div');
        notification.className = `dashboard dashboard-${type}`;

        // Определяем иконку в зависимости от типа
        let icon = '';
        switch(type) {
            case 'success':
                icon = '<i class="bx bx-check-circle" style="color:#0dc8ee"></i>';
                break;
            case 'error':
                icon = '<i class="bx bx-x-circle" style="color:#dc3545"></i>';
                break;
            case 'warning':
                icon = '<i class="bx bx-error" style="color:#ffc107"></i>';
                break;
            case 'info':
            default:
                icon = '<i class="bx bx-info-circle" style="color:#0dc8ee"></i>';
                break;
        }

        // Создаем содержимое уведомления
        notification.innerHTML = `
        <div class="dashboard-icon">${icon}</div>
        <div class="dashboard-content">
            ${title ? `<div class="dashboard-title">${title}</div>` : ''}
            <div class="dashboard-message">${message}</div>
        </div>
        <div class="dashboard-close">&times;</div>
        <div class="dashboard-progress"></div>
    `;

        // Добавляем стили непосредственно к элементу
        notification.style.backgroundColor = '#212529';
        notification.style.color = 'white';
        notification.style.padding = '15px';
        notification.style.marginBottom = '10px';
        notification.style.borderRadius = '8px';
        notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
        notification.style.display = 'flex';
        notification.style.alignItems = 'center';
        notification.style.width = 'auto';
        notification.style.maxWidth = '350px';
        notification.style.transform = 'translateX(100%)';
        notification.style.opacity = '0';
        notification.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease';
        notification.style.borderLeft = '4px solid #4a6cf7';
        notification.style.overflow = 'hidden';

        // Добавляем в контейнер
        container.appendChild(notification);

        // Добавляем обработчик для кнопки закрытия
        const closeButton = notification.querySelector('.dashboard-close');
        closeButton.style.cursor = 'pointer';
        closeButton.style.fontSize = '18px';
        closeButton.style.marginLeft = '10px';
        closeButton.style.opacity = '0.7';
        closeButton.style.transition = 'opacity 0.2s';

        closeButton.addEventListener('click', () => {
            hideDashboardNotification(notification);
        });

        // Стили для иконки
        const iconElement = notification.querySelector('.dashboard-icon');
        iconElement.style.marginRight = '15px';
        iconElement.style.fontSize = '20px';
        iconElement.style.display = 'flex';
        iconElement.style.alignItems = 'center';
        iconElement.style.justifyContent = 'center';

        // Стили для контента
        const contentElement = notification.querySelector('.dashboard-content');
        contentElement.style.flexGrow = '1';

        // Стили для заголовка
        if (title) {
            const titleElement = notification.querySelector('.dashboard-title');
            titleElement.style.fontWeight = 'bold';
            titleElement.style.marginBottom = '5px';
            titleElement.style.fontSize = '16px';
        }

        // Стили для сообщения
        const messageElement = notification.querySelector('.dashboard-message');
        messageElement.style.fontSize = '14px';
        messageElement.style.opacity = '0.9';

        // Стили для прогресс-бара
        const progressBar = notification.querySelector('.dashboard-progress');
        progressBar.style.position = 'absolute';
        progressBar.style.bottom = '0';
        progressBar.style.left = '0';
        progressBar.style.height = '3px';
        progressBar.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
        progressBar.style.width = '100%';
        progressBar.style.transformOrigin = 'left';

        // Показываем уведомление с анимацией
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';

            // Анимируем прогресс-бар
            if (progressBar && duration > 0) {
                progressBar.style.transition = `width ${duration}ms linear`;
                progressBar.style.width = '0';
            }
        }, 10);

        // Автоматически скрываем через указанное время
        if (duration > 0) {
            setTimeout(() => {
                hideDashboardNotification(notification);
            }, duration);
        }

        // Закрываем по клику
        notification.addEventListener('click', (e) => {
            if (!e.target.classList.contains('dashboard-close')) {
                hideDashboardNotification(notification);
            }
        });

        return notification;
    }

    function hideDashboardNotification(notification) {
        notification.style.transform = 'translateX(100%)';
        notification.style.opacity = '0';

        // Удаляем элемент после завершения анимации
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 400);
    }
</script>
{% endblock %}
