{% load static %}

<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Система учета пользователей{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="icon" href="{% static 'img/fav.svg' %}"/>
    <!-- Подключите стили и скрипты CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/mode/javascript/javascript.min.js"></script>
    <!-- Подключаем Flatpickr (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- jQuery и jQuery UI (библиотеки для Drag & Resize) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!-- Стили jQuery UI (чтобы красиво выглядело) -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <!-- Подключаем Sortable.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>


</head>
<body>
<div class="container-fluid">
    <header>

    </header>
</div>



<div class="sidebar">
    <div class="top">
        <div class="logo">
                <a class="navbar-brand d-flex align-items-center" href="/">
                    <img src="{% static 'img/icones.svg' %}" alt="Домой" style="width: 240px; height: 50px;">
                </a>
        </div>
        <i class="bx bx-menu" id="btn"></i>
    </div>
    <ul>
        <li>
            <a href="/">
                <i class='bx bxs-home-alt-2'></i>
                <span class="nav-item">Домой</span>
            </a>
            <span class="tooltip">Домой</span>
        </li>
        <li>
            <a href="{% url 'user_list' %}">
                <i class='bx bxs-user' ></i>
                <span class="nav-item">Пользователи</span>
            </a>
            <span class="tooltip">Пользователи</span>
        </li>
        <li>
            <a href="{% url 'device_list' %}">
                <i class='bx bx-devices' ></i>
                <span class="nav-item">Девайсы</span>
            </a>
            <span class="tooltip">Девайсы</span>
        </li>
        <li>
            <a href="#" data-bs-toggle="modal" data-bs-target="#createSuperUserModal">
                <i class="bi bi-person-fill-gear"></i>
                <span class="nav-item">Добавить суперпользователя</span>
            </a>
            <span class="tooltip">Добавить суперпользователя</span>
        </li>
        <li>
            <a href="#loadSuperUsers" data-bs-toggle="modal" data-bs-target="#superUserModal" onclick="loadSuperUsers()">
                <i class="bi bi-people-fill"></i>
                <span class="nav-item">Показать суперпользователей</span>
            </a>
            <span class="tooltip">Показать суперпользователей</span>
        </li>
        <li>
            <a href="#logsModal" data-bs-toggle="modal" data-bs-target="#logsModal">
                <i class="bi bi-braces-asterisk"></i>
                <span class="nav-item">Просмотр логов</span>
            </a>
            <span class="tooltip">Просмотр логов</span>
        </li>
        <li>
            {% if user.is_authenticated %}
            <form method="post" action="{% url 'logout' %}" class="w-100">
                {% csrf_token %}
                <button type="submit" class="logout-btn">
                    <i class="bx bx-log-out-circle"></i>
                    <span class="nav-item">Выйти</span>
                </button>
            </form>
            <span class="tooltip">Выйти</span>
            {% endif %}
        </li>
    </ul>
</div>

<!-- Модальное окно для отображения суп.польз -->
<div class="modal fade" id="superUserModal" tabindex="-1" aria-labelledby="superUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="superUserModalLabel">Список суперпользователей</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <ul id="superUserList" class="list-group">
                    <!-- Список суперпользователей будет загружен сюда -->
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для создания пользователя -->
<div class="modal fade" id="createSuperUserModal" tabindex="-1" aria-labelledby="createSuperUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createSuperUserModalLabel">Создать суперпользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form id="createSuperUserForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="username" class="form-label">Логин</label>
                        <input type="text" id="username" name="username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" id="email" name="email" class="form-control" required>
                    </div>
                    <div class="mb-3 position-relative">
                        <label for="password" class="form-label">Пароль</label>
                        <div class="input-group">
                            <input type="password" id="password" name="password" class="form-control" required>
                            <span class="input-group-text" onclick="togglePasswordVisibility('password', this)" style="cursor: pointer;">
                                <i class="bi bi-eye"></i>
                            </span>
                        </div>
                    </div>
                    <div class="mb-3 position-relative">
                        <label for="repeat_password" class="form-label">Повторите пароль</label>
                        <div class="input-group">
                            <input type="password" id="repeat_password" name="repeat_password" class="form-control" required>
                            <span class="input-group-text" onclick="togglePasswordVisibility('repeat_password', this)" style="cursor: pointer;">
                                <i class="bi bi-eye"></i>
                            </span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="first_name" class="form-label">Имя</label>
                        <input type="text" id="first_name" name="first_name" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="last_name" class="form-label">Фамилия</label>
                        <input type="text" id="last_name" name="last_name" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Создать</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalLabel">Логи системы</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <!-- Фильтр -->
                <input type="text" id="logSearch" class="form-control mb-3" placeholder="Поиск по логам...">

                <!-- Таблица логов -->
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th><a href="#" class="log-sort" data-sort="datetime">Время</a></th>
                        <th><a href="#" class="log-sort" data-sort="message">Сообщение</a></th>
                        <th><a href="#" class="log-sort" data-sort="auditory_number">Номер аудитории</a></th>
                    </tr>
                    </thead>
                    <tbody id="logsTableBody">
                    <tr><td colspan="4" class="text-center">Загрузка...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <main>
        {% block content %}{% endblock %}
    </main>
    <div class="container">
        <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
            <div class="col-md-4 d-flex align-items-center">
                <a href="/" class="mb-3 me-2 mb-md-0 text-body-secondary text-decoration-none lh-1">
                    <img class="bi" width="42" height="24" src="{% static 'img/fav.svg' %}"></img>
                </a>
                <span class="mb-3 mb-md-0 text-body-secondary">© 2025 ver 1.1</span>
            </div>

            <ul class="nav col-md-4 justify-content-end list-unstyled d-flex">
                <li class="nav-item"><a href="https://t.me/aohameow" class="nav-link px-2 text-body-secondary">About</a></li>
            </ul>
        </footer>
    </div>
</div>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 90px;
        background-color: #2c3034;
        transition: width 0.5s ease;
    }
    .sidebar.active {
        width: 350px;
    }
    .sidebar ul {
        padding: 10px;
    }
    .sidebar ul li {
        position: relative;
        list-style: none;
        margin: 15px 0;
    }
    .sidebar ul li a {
        color: #fff;
        display: flex;
        align-items: center;
        text-decoration: none;
        padding: 10px;
        border-radius: 5px;
        transition: background 0.3s;
    }
    .sidebar ul li a:hover {
        background: rgba(13,110,253, 1);
    }
    .sidebar ul li a i {
        font-size: 24px;
        width: 48px;
        text-align: center;
    }
    .sidebar ul li .nav-item {
        opacity: 0;
        transition: opacity 0.3s;
        white-space: nowrap;
    }
    .sidebar.active ul li .nav-item {
        opacity: 1;
    }
    .tooltip {
        position: absolute;
        left: 80px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(44,48,52, 1);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
    }
    .sidebar:not(.active) ul li:hover .tooltip {
        opacity: 1;
    }
    .sidebar #btn {
        position: absolute;
        color: #fff;
        top: 15px;
        left: 50%;
        font-size: 1.5rem;
        transform: translateX(-50%);
        cursor: pointer;
    }
    .sidebar.active #btn {
        left: 90%;
    }
    .sidebar .top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
    }
    .sidebar .top .logo {
        display: flex;
        align-items: center;
        color: #fff;
        font-size: 1.5rem;
        display: none;
        transition: opacity 0.3s ease;
    }
    .sidebar.active .top .logo {
        display: inline;
    }
    .content {
        margin-left: 80px;
        transition: margin-left 0.3s;
    }
    .sidebar.active ~ .content {
        margin-left: 250px;
    }
    .logout-btn {
        background: none;
        border: none;
        color: white;
        width: 100%;
        display: flex;
        align-items: center;
        padding: 10px;
        text-align: left;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.3s;
        font-size: 16px;
    }

    .logout-btn i {
        font-size: 24px;
        width: 50px;
        text-align: center;
    }

    .logout-btn:hover {
        background: rgba(220, 53, 69);
    }
</style>

<script>
    let menuBtn = document.querySelector('#btn');
    let sidebar = document.querySelector('.sidebar');

    // Загружаем состояние меню из localStorage
    if (localStorage.getItem('sidebarActive') === 'true') {
        sidebar.classList.add('active');
    }

    menuBtn.onclick = function () {
        sidebar.classList.toggle('active');

        // Сохраняем состояние меню в localStorage
        localStorage.setItem('sidebarActive', sidebar.classList.contains('active'));
    };
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');

        if (!notification) {
            console.error('Элемент для уведомлений (id="notification") не найден.');
            return;
        }

        notification.textContent = message;
        notification.className = `alert alert-${type} alert-dismissible fade show`; // Bootstrap стили
        notification.classList.remove('d-none'); // Показываем уведомление

        // Автоматическое скрытие уведомления через 5 секунд
        setTimeout(() => {
            notification.classList.add('d-none');
            notification.className = 'alert d-none'; // Сбрасываем стили
            notification.textContent = '';
        }, 5000);
    }

    document.getElementById('createSuperUserForm').addEventListener('submit', function (e) {
        e.preventDefault(); // Отключаем стандартное поведение формы

        const form = this;
        const password = document.getElementById('password').value;
        const repeatPassword = document.getElementById('repeat_password').value;

        // Проверяем совпадение паролей
        if (password !== repeatPassword) {
            showNotification('Пароли не совпадают. Попробуйте ещё раз.', 'danger');
            return;
        }

        const data = new FormData(form);
        fetch("{% url 'create_superuser_ajax' %}", {
            method: "POST",
            body: data,
            headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    form.reset(); // Очищаем форму
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createSuperUserModal'));
                    modal.hide();

                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                } else {
                    showNotification(data.message, 'danger');
                }
            })
            .catch(error => {
                showNotification('Произошла ошибка. Попробуйте ещё раз.', 'danger');
                console.error('Ошибка:', error);
            });
    });
    document.addEventListener('hidden.bs.modal', function (event) {
        const modal = event.target;
        if (modal.id === 'createSuperUserModal') {
            // Очищаем форму при повторном открытии
            document.getElementById('createSuperUserForm').reset();

            // Удаляем остаточные классы и элементы, если есть
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
        }
    });
    function togglePasswordVisibility(fieldId, element) {
        const field = document.getElementById(fieldId);
        const icon = element.querySelector('i');

        if (field.type === "password") {
            field.type = "text";
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            field.type = "password";
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }
    function loadSuperUsers() {
        fetch("{% url 'get_superusers' %}")
            .then(response => response.json())
            .then(data => {
                const superUserList = document.getElementById('superUserList');
                superUserList.innerHTML = ''; // Очищаем список

                if (data.superusers && data.superusers.length > 0) {
                    data.superusers.forEach(user => {
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item';
                        listItem.textContent = `${user.username} (${user.email || 'без email'})`;
                        superUserList.appendChild(listItem);
                    });
                } else {
                    const noUsersItem = document.createElement('li');
                    noUsersItem.className = 'list-group-item text-danger';
                    noUsersItem.textContent = 'Суперпользователи не найдены.';
                    superUserList.appendChild(noUsersItem);
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки суперпользователей:', error);
                const superUserList = document.getElementById('superUserList');
                superUserList.innerHTML = '<li class="list-group-item text-danger">Не удалось загрузить список суперпользователей.</li>';
            });
    }

    $(document).ready(function() {
        let isLoaded = false;  // Флаг, чтобы предотвратить многократную загрузку

        function loadLogs(search = '', sort = 'datetime') {
            $.ajax({
                url: "{% url 'log_list_ajax' %}",
                data: { search: search, sort: sort },
                success: function(data) {
                    $("#logsTableBody").html(data);
                }
            });
        }

        // Загружаем логи ТОЛЬКО ПРИ ПЕРВОМ ОТКРЫТИИ модального окна
        $('#logsModal').on('shown.bs.modal', function() {
            if (!isLoaded) {
                loadLogs();
                isLoaded = true;
                console.log("Modal windows is open!");
            }
        });

        // Обновляем таблицу логов при вводе текста в поиск
        $('#logSearch').on('input', function() {
            loadLogs($(this).val());
        });

        // Сортировка логов
        $('.log-sort').on('click', function(e) {
            e.preventDefault();
            let sort_by = $(this).data('sort');
            loadLogs($('#logSearch').val(), sort_by);
        });
    });
</script>

</body>
</html>
